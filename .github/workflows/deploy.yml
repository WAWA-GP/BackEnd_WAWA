name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
      run: |
        # SSH í‚¤ ì„¤ì •
        echo "$EC2_SSH_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # EC2ì— ë°°í¬
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
          cd /var/www/language-learning-api
          
          # Git pull
          git pull origin main
          
          # ê°€ìƒí™˜ê²½ í™œì„±í™”
          source .venv/bin/activate
          
          # ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
          pip install -r requirements.txt
          
          # í™˜ê²½ë³€ìˆ˜ ì—…ë°ì´íŠ¸
          cat > .env << 'EOF'
        ENVIRONMENT=production
        DEBUG=false
        HOST=0.0.0.0
        PORT=8000
        
        OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        SUPABASE_URL=${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        
        CORS_ORIGINS=http://localhost:3000,http://13.48.248.250
        EOF
          
          # Python ìºì‹œ ì‚­ì œ
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          sudo systemctl restart language-learning-api
          
          # ìƒíƒœ í™•ì¸
          sleep 3
          curl -f http://localhost:8000/health || exit 1
          
          echo "âœ… Deployment completed successfully!"
        ENDSSH
    
    - name: Cleanup
      if: always()
      run: rm -f private_key.pem
    
    - name: Notify success
      if: success()
      run: echo "ğŸ‰ Deployment successful!"
    
    - name: Notify failure
      if: failure()
      run: echo "âŒ Deployment failed!"